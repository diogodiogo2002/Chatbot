const infoSVG = `<svg id="Bold" viewBox="0 0 24 24" width="32" height="32"><path fill = "currentcolor" d="M19.061,7.854a1.5,1.5,0,0,0-2.122,0l-4.586,4.585a.5.5,0,0,1-.707,0L7.061,7.854A1.5,1.5,0,0,0,4.939,9.975l4.586,4.586a3.5,3.5,0,0,0,4.95,0l4.586-4.586A1.5,1.5,0,0,0,19.061,7.854Z"/></svg>`
const copySVG = `<svg  id="Layer_1" height="32" viewBox="0 0 24 24" width="32" data-name="Layer 1"><path fill = "currentcolor" d="m13.5 19h-8a5.506 5.506 0 0 1 -5.5-5.5v-8a5.506 5.506 0 0 1 5.5-5.5h8a5.506 5.506 0 0 1 5.5 5.5v8a5.506 5.506 0 0 1 -5.5 5.5zm-8-16a2.5 2.5 0 0 0 -2.5 2.5v8a2.5 2.5 0 0 0 2.5 2.5h8a2.5 2.5 0 0 0 2.5-2.5v-8a2.5 2.5 0 0 0 -2.5-2.5zm18.5 15.5v-11.5a1.5 1.5 0 0 0 -3 0v11.5a2.5 2.5 0 0 1 -2.5 2.5h-11.5a1.5 1.5 0 0 0 0 3h11.5a5.506 5.506 0 0 0 5.5-5.5z"/></svg>`
const checkSVG = `<svg version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 507.506 507.506" style="enable-background:new 0 0 507.506 507.506;" xml:space="preserve" width="32" height="32"><g><path fill = "currentcolor" d="M163.865,436.934c-14.406,0.006-28.222-5.72-38.4-15.915L9.369,304.966c-12.492-12.496-12.492-32.752,0-45.248l0,0   c12.496-12.492,32.752-12.492,45.248,0l109.248,109.248L452.889,79.942c12.496-12.492,32.752-12.492,45.248,0l0,0   c12.492,12.496,12.492,32.752,0,45.248L202.265,421.019C192.087,431.214,178.271,436.94,163.865,436.934z"/></g></svg>`
const speakSVG = `<svg viewBox="0 0 24 24"><path fill= "currentcolor" d="M24,17c0,2.479-.965,4.809-2.718,6.561-.293,.293-.677,.439-1.061,.439s-.768-.146-1.061-.439c-.586-.586-.586-1.536,0-2.121,1.186-1.186,1.839-2.763,1.839-4.439s-.653-3.254-1.839-4.439c-.586-.585-.586-1.535,0-2.121s1.535-.586,2.121,0c1.753,1.752,2.718,4.082,2.718,6.561Zm-6.268-3.061c-.586-.586-1.535-.586-2.121,0s-.586,1.535,0,2.121c.251,.251,.389,.585,.389,.939s-.138,.688-.389,.939c-.586,.586-.586,1.535,0,2.121,.293,.293,.677,.439,1.061,.439s.768-.146,1.061-.439c1.688-1.688,1.688-4.434,0-6.121ZM1.416,.018C.589,.064-.044,.772,.002,1.6c.046,.828,.754,1.446,1.582,1.414,2.697-.155,5.273,1.054,6.932,3.266,.965,1.193,2.653,4.251,3.268,5.721h-.39c-.756,0-1.394,.562-1.488,1.312l-.371,2.938c-.126,.998-.979,1.75-1.984,1.75h-1.05c-.829,0-1.5,.672-1.5,1.5v1c0,.275-.224,.5-.5,.5H1.5c-.829,0-1.5,.672-1.5,1.5s.671,1.5,1.5,1.5h3c1.766,0,3.231-1.315,3.467-3.018,2.329-.194,4.247-2.002,4.544-4.356l.206-1.631c1.484-.087,2.283-1.303,2.283-2.449,0-1.662-3.135-6.896-4.118-8.109C8.655,1.463,5.124-.189,1.416,.018Z"/></svg>`
const xSVG = `<svg   viewBox="0 0 24 24" width="32" height="32"><path fill = "currentcolor" d="M13.93,12L21.666,2.443c.521-.644,.422-1.588-.223-2.109-.645-.522-1.588-.421-2.109,.223l-7.334,9.06L4.666,.557c-1.241-1.519-3.56,.357-2.332,1.887l7.736,9.557L2.334,21.557c-.521,.644-.422,1.588,.223,2.109,.64,.519,1.586,.424,2.109-.223l7.334-9.06,7.334,9.06c.524,.647,1.47,.742,2.109,.223,.645-.521,.744-1.466,.223-2.109l-7.736-9.557Z"/></svg>`
const positiveSVG = `<svg viewBox="0 0 512 512" width="32" height="32"><path fill = "currentcolor" d="M485.379,170.88c-22.148-27.445-55.547-43.367-90.815-43.293H351.25l1.913-11.222c7.798-45.716-22.94-89.097-68.656-96.895  c-5.03-0.858-10.128-1.256-15.23-1.188c-32.056-0.167-61.464,17.761-76.001,46.332l-32.135,62.973h-44.249  C52.364,127.658,0.07,179.951,0,244.48v106.266c0.07,64.529,52.364,116.822,116.892,116.892H372.1  c55.158-0.2,102.743-38.764,114.363-92.685l22.465-106.266C516.299,234.201,507.639,198.232,485.379,170.88z M63.759,350.745V244.48  c0-29.344,23.788-53.133,53.133-53.133h31.88v212.531h-31.88C87.548,403.878,63.759,380.09,63.759,350.745z M446.549,255.489  l-22.486,106.266c-5.273,24.506-26.897,42.035-51.964,42.124H212.531V167.139l37.533-73.557c3.978-7.446,11.886-11.937,20.318-11.54  c11.174,0.007,20.227,9.072,20.22,20.246c-0.001,1.128-0.096,2.254-0.284,3.366l-14.601,85.693h118.847  c29.344-0.003,53.135,23.783,53.138,53.127C447.703,248.176,447.316,251.867,446.549,255.489L446.549,255.489z"/></svg>`
const negativeSVG = `<svg viewBox="0 0 512 512" width="32" height="32"><path fill = "currentcolor" d="M486.715,143.036c-11.609-53.966-59.222-92.571-114.422-92.775h-255.34C52.387,50.343,0.07,102.67,0,167.235v106.321  c0.07,64.562,52.391,116.882,116.953,116.953h44.251l32.173,63.006c14.81,28.863,44.709,46.829,77.146,46.356  c46.4,0.061,84.064-37.504,84.125-83.904c0.006-4.769-0.393-9.529-1.195-14.23l-1.914-11.227h43.336  c64.591,0,116.953-52.361,116.953-116.952c0-8.132-0.848-16.243-2.531-24.199L486.715,143.036z M63.792,273.556V167.235  c0-29.36,23.801-53.16,53.16-53.16h31.896v212.641h-31.896C87.593,326.716,63.792,302.916,63.792,273.556z M436.063,307.047  c-10.077,12.471-25.262,19.703-41.295,19.669H275.859l14.608,85.737c1.047,5.875-0.6,11.909-4.487,16.437  c-4.135,4.798-10.236,7.445-16.565,7.187c-8.051,0.085-15.459-4.385-19.138-11.546l-37.637-73.51V114.075h159.651  c25.092,0.074,46.738,17.63,51.991,42.167l22.497,106.321C450.131,278.248,446.189,294.607,436.063,307.047z"/></svg>`

const form = document.getElementById("chat-form");
const chatBox = document.getElementById("chat-box");
const chatTitle = document.getElementById("chat-title");
const chatWidget = document.getElementById("chat-widget");
const chatToggle = document.getElementById("chat-toggle");
const input = document.getElementById("user-input");

let opinion = false;
let can_reply = true;
let speaking = false;
let currentQuizData = [];


function stopSpeaking() {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
  }
}

function speakText(text) {
  if (!window.speechSynthesis) {
    console.warn("Seu navegador não suporta síntese de voz.");
    return;
  }

  stopSpeaking(); // Cancela qualquer fala anterior
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "pt-PT"; // ou "pt-BR", conforme preferires

  speaking = true;
  window.speechSynthesis.speak(utterance);

  utterance.onend = () => {
    speaking = false;
  };

  utterance.onerror = () => {
    speaking = false;
  };
}
function addMessage(text, sender, info_text) {
  const msg = document.createElement("div");
  msg.classList.add("message", sender);

  if (sender === "bot" && info_text != null) {
    const contentWrapper = document.createElement("div");
    contentWrapper.classList.add("bot-content");

    const msgText = document.createElement("div");
    msgText.innerText = text;
    msgText.classList.add("bot-text");

    const infoBox = document.createElement("div");
    infoBox.textContent = info_text;
    infoBox.classList.add("info-box");

    const toggleBtn = document.createElement("button");
    toggleBtn.innerHTML = infoSVG;
    toggleBtn.classList.add("info-toggle-outside");

    
    const copyBtn = document.createElement("button");
    copyBtn.innerHTML = copySVG;
    copyBtn.classList.add("copy-btn");

    const speakBtn = document.createElement("button");
    speakBtn.innerHTML = speakSVG;
    speakBtn.classList.add("speak-btn");

    const positiveBtn = document.createElement("button");
    positiveBtn.innerHTML = positiveSVG;
    positiveBtn.classList.add("positive-btn");

    const negativeBtn = document.createElement("button");
    negativeBtn.innerHTML = negativeSVG;
    negativeBtn.classList.add("negative-btn");
    
    copy_info = text; 

    copyBtn.addEventListener("click", () => {
      navigator.clipboard.writeText(copy_info).then(() => {
        copyBtn.innerHTML = checkSVG;
        setTimeout(() => {
          copyBtn.innerHTML = copySVG;
        }, 1000);
      }).catch(err => {
        console.error("Erro ao copiar para a área de transferência: ", err);
      });
    });


    positiveBtn.addEventListener("click", () => {
      positiveBtn.classList.add("shrink-out");
      negativeBtn.classList.add("shrink-out");
      addMessage("Obrigado pelo teu feedback!", "bot");
      setTimeout(() => {
        positiveBtn.remove();
        negativeBtn.remove();
      }, 300);
    });

    negativeBtn.addEventListener("click", () => {
      positiveBtn.classList.add("shrink-out");
      negativeBtn.classList.add("shrink-out");
      addMessage("Obrigado pelo teu feedback!", "bot");
      setTimeout(() => {
        positiveBtn.remove();
        negativeBtn.remove();
      }, 300);
    });


    toggleBtn.addEventListener("click", () => {
      const showingInfo = infoBox.classList.contains("visible");

      const svg = toggleBtn.querySelector("svg");
      svg.classList.toggle("rotated"); // alterna a rotação

      if (showingInfo) {
        // Ocultar info e mostrar texto normal
        infoBox.classList.remove("visible");
        msgText.classList.remove("hidden");
        copy_info = text;
      }else {
        // Mostrar info e esconder texto normal
        msgText.classList.add("hidden");
        infoBox.classList.add("visible");
        copy_info = info_text;
      }
      });

      speakBtn.addEventListener("click", ()=>{
        if (!speaking) {
        speakText(text); // Fala o que está visível
        speakBtn.innerHTML = xSVG;
        } else {
          stopSpeaking();
          speaking = false;
          speakBtn.innerHTML = speakSVG;
        }
      });

      const buttonsWrapper = document.createElement("div");
      buttonsWrapper.classList.add("buttons-wrapper");

      // Adicionar os botões ao container
      buttonsWrapper.appendChild(positiveBtn);
      buttonsWrapper.appendChild(negativeBtn);
      buttonsWrapper.appendChild(toggleBtn);
      buttonsWrapper.appendChild(speakBtn)
      buttonsWrapper.appendChild(copyBtn);
      

      contentWrapper.appendChild(msgText);

      if (info_text != null) {
        contentWrapper.appendChild(infoBox);
        contentWrapper.appendChild(buttonsWrapper);
      
        msg.appendChild(contentWrapper);
      }
  }else {
    msg.textContent = text;
  }

  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function renderQuiz(quiz) {
  currentQuizData = quiz;
  const chatBox = document.getElementById("chat-box");
  
  // Cria container do quiz dentro do chat
  const quizDiv = document.createElement("div");
  quizDiv.classList.add("quiz-message");

  quiz.forEach((item, index) => {
    const questionDiv = document.createElement("div");
    questionDiv.classList.add("quiz-question");

    const questionTitle = document.createElement("h4");
    questionTitle.textContent = `${index + 1}. ${item.question}`;
    questionDiv.appendChild(questionTitle);

    const optionsDiv = document.createElement("div");
    optionsDiv.classList.add("quiz-options");

    for (const [key, option] of Object.entries(item.options)) {
      const label = document.createElement("label");
      label.style.display = "block";
      label.style.marginBottom = "5px";
      label.innerHTML = `
        <input type="radio" name="q${index}" value="${key}">
        ${key}: ${option}
      `;
      optionsDiv.appendChild(label);
    }

    questionDiv.appendChild(optionsDiv);
    quizDiv.appendChild(questionDiv);
  });

  // Botão para submeter respostas
  const submitBtn = document.createElement("button");
  submitBtn.textContent = "Submeter Respostas";
  submitBtn.classList.add("quiz-submit-btn");

  quizDiv.appendChild(submitBtn);

  submitBtn.addEventListener("click", () => validateQuiz(quizDiv));

  chatBox.appendChild(quizDiv);

  // Scroll para o final para o utilizador ver o quiz
  chatBox.scrollTop = chatBox.scrollHeight;
}


function validateQuiz(quizContainer) {
  let score = 0;

  const questions = quizContainer.querySelectorAll(".quiz-question");

  currentQuizData.forEach((item, index) => {
    const selected = quizContainer.querySelector(`input[name="q${index}"]:checked`);
    const questionDiv = questions[index];

    // Limpar classes anteriores
    questionDiv.classList.remove("correct", "incorrect");

    if (!selected) {
      questionDiv.classList.add("incorrect");
      return;
    }

    if (selected.value === item.correct_answer) {
      score++;
      questionDiv.classList.add("correct");
    } else {
      questionDiv.classList.add("incorrect");
    }
  });

  addMessage(`Acertaste ${score} de ${currentQuizData.length} perguntas!`, "bot");

  if (score === currentQuizData.length) {
    addMessage("Parabéns! Respondeste corretamente a todas as perguntas do quiz!", "bot");
  }
}

